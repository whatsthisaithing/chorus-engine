<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chorus Engine</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <!-- Custom CSS -->
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-dark text-white p-3 d-flex flex-column">
                <h4 class="mb-4 text-theme-secondary" style="white-space: nowrap;">
                    Chorus Engine
                </h4>
                
                <!-- CHARACTER Section -->
                <div class="sidebar-section mb-4">
                    <h6 class="sidebar-section-header text-muted text-uppercase small mb-2">Character</h6>
                    <div class="mb-2 d-flex gap-1">
                        <select id="characterSelect" class="form-select form-select-sm bg-dark text-white flex-grow-1">
                            <option value="">Loading...</option>
                        </select>
                        <button id="openCharacterConfig" class="btn btn-sm btn-outline-secondary" title="Character Configuration">
                            <i class="bi bi-gear-fill"></i>
                        </button>
                    </div>
                    
                    <!-- Character Profile Card -->
                    <div id="characterProfileCard" class="character-profile-card mb-3" style="display: none;">
                        <div class="profile-avatar-container">
                            <img id="profileAvatar" src="/character_images/default.svg" alt="Character Avatar" class="profile-avatar">
                        </div>
                        <div class="profile-info">
                            <h6 id="profileName" class="profile-name mb-1">Character Name</h6>
                            <div id="profileRole" class="profile-role small mb-2">Role</div>
                            
                            <div class="profile-stats mb-2">
                                <div class="stat-item">
                                    <i class="bi bi-chat-dots" title="Conversations"></i>
                                    <span id="statConversations">0</span>
                                    <small>Convos</small>
                                </div>
                                <div class="stat-item">
                                    <i class="bi bi-chat-text" title="Messages"></i>
                                    <span id="statMessages">0</span>
                                    <small>Msgs</small>
                                </div>
                                <div class="stat-item">
                                    <i class="bi bi-journal-text" title="Memories"></i>
                                    <span id="statMemories">0</span>
                                    <small>Mem</small>
                                </div>
                                <div class="stat-item">
                                    <i class="bi bi-star" title="Core Memories"></i>
                                    <span id="statCore">0</span>
                                    <small>Core</small>
                                </div>
                            </div>
                            
                            <div class="profile-capabilities-section mb-2">
                                <div class="capabilities-heading">Capabilities</div>
                                <div id="profileCapabilities" class="profile-capabilities">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            
                            <button id="viewFullProfileBtn" class="btn btn-outline-warning btn-sm w-100">
                                <i class="bi bi-person-circle me-1"></i> View Full Profile
                            </button>
                        </div>
                    </div>
                    
                    <button id="manageVoiceSamplesBtn" class="btn btn-outline-light btn-sm w-100 mb-2" disabled>
                        <i class="bi bi-mic-fill me-1"></i> Voice Samples
                    </button>
                    <button id="manageWorkflowsBtn" class="btn btn-outline-light btn-sm w-100 mb-2" disabled>
                        <i class="bi bi-diagram-3-fill me-1"></i> Workflows
                    </button>
                    <button id="documentLibraryBtn" class="btn btn-outline-light btn-sm w-100 mb-2" style="display: none;">
                        <i class="bi bi-file-earmark-text me-1"></i> Document Library
                    </button>
                </div>
                
                <!-- CONVERSATION Section -->
                <div class="sidebar-section">
                    <h6 class="sidebar-section-header text-muted text-uppercase small mb-2">Conversation</h6>
                    <button id="newConversationBtn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-plus-circle me-1"></i> New Conversation
                    </button>
                    <button id="memoryPanelBtn" class="btn btn-outline-light btn-sm w-100 mb-2" disabled>
                        <i class="bi bi-database me-1"></i> Memory
                    </button>
                    <button id="pending-memories-btn" class="btn btn-outline-light btn-sm w-100 mb-3" disabled>
                        <i class="bi bi-hourglass-split me-1"></i> Pending Memories
                        <span id="pending-count" class="badge bg-danger">0</span>
                    </button>
                    
                    <!-- Conversation List -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="small text-theme-secondary mb-0">Recent</h6>
                            <select id="conversationSourceFilter" class="form-select form-select-sm" style="width: auto; font-size: 0.75rem;">
                                <option value="web">Web</option>
                                <option value="discord">Discord</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div id="conversationList" class="conversation-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Settings at bottom -->
                <div class="mt-auto pt-3 border-top" style="border-color: var(--border-color) !important;">
                    <div class="dropdown dropup">
                        <button class="btn btn-sm btn-outline-secondary w-100" type="button" id="settingsMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-gear-fill me-2"></i>Settings
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="settingsMenuBtn">
                            <li><h6 class="dropdown-header">User Settings</h6></li>
                            <li><a class="dropdown-item" href="#" id="setUsernameMenuItem">
                                <i class="bi bi-person me-2"></i>Set Username
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Configuration</h6></li>
                            <li><a class="dropdown-item" href="#" id="exportCharacterMenuItem">
                                <i class="bi bi-download me-2"></i>Export Character
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="importCharacterMenuItem">
                                <i class="bi bi-upload me-2"></i>Import Character
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="importCharacterCardMenuItem">
                                <i class="bi bi-card-image me-2"></i>Import Character Card
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="exportSystemConfigMenuItem">
                                <i class="bi bi-file-earmark-arrow-down me-2"></i>Export System Config
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="importSystemConfigMenuItem">
                                <i class="bi bi-file-earmark-arrow-up me-2"></i>Import System Config
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="modelManagementMenuItem">
                                <i class="bi bi-cpu me-2"></i>Model Manager
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="viewServerLogsMenuItem">
                                <i class="bi bi-terminal me-2"></i>View Server Logs
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" id="resetDatabaseMenuItem">
                                <i class="bi bi-exclamation-triangle me-2"></i>Reset Database
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="col-md-9 col-lg-10 d-flex flex-column p-0">
                <!-- Model Missing Warning Banner -->
                <div id="modelMissingBanner" class="alert alert-warning m-3 mb-0" role="alert" style="display: none;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>No Model Loaded</strong>
                                <p class="mb-0 small">Download a model to start chatting with your characters.</p>
                            </div>
                        </div>
                        <button id="openModelManagerBtn" class="btn btn-sm btn-warning">
                            <i class="bi bi-cpu me-1"></i>Download Model
                        </button>
                    </div>
                </div>
                <!-- Header -->
                <div class="chat-header p-3 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div>
                                <h5 class="mb-0 d-inline-block" id="conversationTitle" contenteditable="false" style="cursor: text;">Select a conversation</h5>
                                <small class="text-muted ms-2" id="characterName"></small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <!-- Privacy Toggle - Simplified -->
                            <div class="form-check form-switch privacy-toggle m-0" title="Private messages are saved but won't be used for memory extraction">
                                <input class="form-check-input" type="checkbox" id="privacyToggle" disabled>
                                <label class="form-check-label" for="privacyToggle">
                                    <i class="bi bi-lock-fill"></i>
                                    <span class="ms-1">Private</span>
                                </label>
                            </div>
                            <!-- TTS Toggle - Simplified -->
                            <div class="form-check form-switch tts-toggle m-0" title="Enable text-to-speech for assistant messages">
                                <input class="form-check-input" type="checkbox" id="ttsToggle" disabled>
                                <label class="form-check-label" for="ttsToggle">
                                    <i class="bi bi-volume-up-fill"></i>
                                    <span class="ms-1">TTS</span>
                                </label>
                            </div>
                            <!-- Actions Dropdown Menu -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" id="actionsMenuBtn" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsMenuBtn">
                                    <li><a class="dropdown-item" href="#" id="analyzeMenuItem">
                                        <i class="bi bi-lightbulb me-2"></i>Analyze Conversation
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="analysisHistoryMenuItem">
                                        <i class="bi bi-clock-history me-2"></i>Analysis History
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="viewDebugLogMenuItem">
                                        <i class="bi bi-journal-code me-2"></i>View Debug Log
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="viewExtractionLogMenuItem">
                                        <i class="bi bi-journal-text me-2"></i>View Extraction Log
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="viewImageRequestLogMenuItem">
                                        <i class="bi bi-image me-2"></i>View Image Request Log
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="exportMenuItem">
                                        <i class="bi bi-download me-2"></i>Export Conversation
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="editTitleMenuItem">
                                        <i class="bi bi-pencil me-2"></i>Edit Title
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" id="deleteMenuItem">
                                        <i class="bi bi-trash me-2"></i>Delete Conversation
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Thread Tabs -->
                    <div class="mt-4">
                        <ul class="nav nav-tabs" id="threadTabs">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="flex-grow-1 overflow-auto p-3" id="messagesContainer">
                    <!-- Messages populated by JS -->
                    <div class="text-center text-theme-secondary mt-5" id="emptyState">
                        <i class="bi bi-chat-text" style="font-size: 4rem;"></i>
                        <p class="mt-3">Select a character and start a new conversation</p>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="chat-input border-top p-3 bg-light">
                    <form id="messageForm">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="messageInput" 
                                class="form-control" 
                                placeholder="Type your message..." 
                                disabled
                                autocomplete="off"
                            >
                            <!-- Phase 9: Scene Capture Button -->
                            <button 
                                type="button" 
                                id="sceneCaptureBtn" 
                                class="btn btn-outline-secondary" 
                                title="Capture Scene (Image)"
                                style="display: none; border: none;"
                                disabled
                            >
                                <i class="bi bi-camera-fill"></i>
                            </button>
                            <!-- Video Scene Capture Button -->
                            <button 
                                type="button" 
                                id="videoSceneCaptureBtn" 
                                class="btn btn-outline-secondary" 
                                title="Capture Scene (Video)"
                                style="display: none; border: none;"
                                disabled
                            >
                                <i class="bi bi-camera-video-fill"></i>
                            </button>
                            <button 
                                type="submit" 
                                id="sendBtn" 
                                class="btn btn-primary" 
                                disabled
                            >
                                <i class="bi bi-send-fill"></i> Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Phase 9: Media Gallery Panel -->
    <div id="imageGallery" class="gallery-panel collapsed">
        <button class="gallery-toggle" onclick="App.toggleImageGallery()" title="Media Gallery">
            <i class="bi bi-images"></i>
            <span class="gallery-count">0</span>
        </button>
        
        <div class="gallery-content">
            <div class="gallery-header">
                <h5 class="text-dark"><i class="bi bi-collection me-2"></i>Media Gallery</h5>
                <button class="btn-close-gallery" onclick="App.toggleImageGallery()" aria-label="Close">&times;</button>
            </div>
            
            <!-- Images Section -->
            <div class="gallery-section">
                <h6 class="text-muted px-3 mt-3 mb-2"><i class="bi bi-images me-1"></i>Images <span id="imageCount" class="badge bg-secondary">0</span></h6>
                <div class="gallery-grid" id="galleryGrid">
                    <p class="text-muted text-center mt-2">No images yet</p>
                </div>
            </div>
            
            <!-- Videos Section -->
            <div class="gallery-section">
                <h6 class="text-muted px-3 mt-3 mb-2"><i class="bi bi-camera-video me-1"></i>Videos <span id="videoCount" class="badge bg-secondary">0</span></h6>
                <div class="gallery-grid" id="videoGalleryGrid">
                    <p class="text-muted text-center mt-2">No videos yet</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Modal -->
    <div class="modal" id="loadingModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">Generating response...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Username Modal -->
    <div class="modal fade" id="usernameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Set Username</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">
                        Your username helps the assistant identify you in conversations. 
                        It's stored locally in your browser.
                    </p>
                    <div class="mb-3">
                        <label for="usernameInput" class="form-label">Username</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="usernameInput" 
                               placeholder="Enter your name" maxlength="50">
                        <div class="form-text text-muted">Leave empty to use "User" as default</div>
                    </div>
                    <div class="small text-muted">
                        <i class="bi bi-info-circle"></i> User ID: <code id="currentUserId" class="text-warning bg-dark px-2 py-1 rounded"></code>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUsernameBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Results Modal -->
    <div class="modal fade" id="analysisResultsModal" tabindex="-1" aria-labelledby="analysisResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="analysisResultsModalLabel">
                        <i class="bi bi-lightbulb-fill text-info"></i> Analysis Results
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="analysisLoadingSpinner" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Analyzing...</span>
                        </div>
                        <p class="mt-3 text-theme-secondary">Analyzing conversation...</p>
                    </div>
                    
                    <div id="analysisResults" style="display: none;">
                        <!-- Summary Section -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2"><i class="bi bi-card-text"></i> Summary</h6>
                            <p id="analysisSummary"></p>
                        </div>
                        
                        <!-- Metadata -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2"><i class="bi bi-tags"></i> Themes</h6>
                                <div id="analysisThemes"></div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2"><i class="bi bi-emoji-smile"></i> Tone</h6>
                                <p id="analysisTone"></p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2"><i class="bi bi-heart-pulse"></i> Emotional Arc</h6>
                            <p id="analysisEmotionalArc"></p>
                        </div>
                        
                        <!-- Memory Counts -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="bi bi-database"></i> Memories Extracted 
                                <span id="analysisMemoryTotal" class="badge bg-info">0</span>
                            </h6>
                            <div id="analysisMemoryCounts" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        
                        <!-- Detailed Memories -->
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2"><i class="bi bi-list-ul"></i> Extracted Memories</h6>
                            <div id="analysisMemoriesList" class="list-group"></div>
                        </div>
                    </div>
                    
                    <div id="analysisError" style="display: none;" class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <span id="analysisErrorMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis History Modal -->
    <div class="modal fade" id="analysisHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-clock-history me-2"></i>Analysis History
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading spinner -->
                    <div id="historyLoadingSpinner" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-theme-secondary">Loading analysis history...</p>
                    </div>

                    <!-- Error message -->
                    <div id="historyError" class="alert alert-danger" style="display: none;"></div>

                    <!-- History list -->
                    <div id="historyList" style="display: none;">
                        <div id="historyItems" class="list-group"></div>
                    </div>

                    <!-- Empty state -->
                    <div id="historyEmpty" class="text-center py-4" style="display: none;">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-theme-secondary mt-2">No analyses yet. Click "Analyze Now" to create the first one!</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings Modal -->
    <div class="modal fade" id="systemSettingsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark text-theme-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-gear-fill me-2"></i>System Configuration
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Warning Banner -->
                    <div class="alert alert-danger d-flex align-items-start" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                        <div>
                            <h6 class="alert-heading mb-2">⚠️ Warning: Advanced System Configuration</h6>
                            <p class="mb-2">Changes to these settings affect the entire system and <strong>require a server restart</strong> to take effect.</p>
                            <p class="mb-0">
                                <strong>Recommendation:</strong> Backup your <code>config/system.yaml</code> file before making changes.
                                Incorrect configuration can prevent the system from starting.
                            </p>
                        </div>
                    </div>

                    <!-- Settings Form -->
                    <form id="systemSettingsForm">
                        <!-- LLM Provider Configuration -->
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="bi bi-cpu me-2"></i>LLM Provider Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Provider</label>
                                        <select class="form-select bg-dark text-light border-secondary" id="llm_provider" required>
                                            <option value="ollama">Ollama (Multi-model, auto-loading)</option>
                                            <option value="lmstudio">LM Studio (Multi-model, JIT loading)</option>
                                            <option value="koboldcpp">KoboldCpp (Single-model, manual loading)</option>
                                        </select>
                                        <div class="form-text text-secondary">Ollama: Recommended (use Model Manager to download). LM Studio: External server. KoboldCpp: Manual model loading.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Base URL</label>
                                        <input type="url" class="form-control bg-dark text-light border-secondary" id="llm_base_url" placeholder="http://localhost:11434">
                                        <div class="form-text text-secondary">API endpoint for the LLM provider (Ollama default: http://localhost:11434).</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Model</label>
                                        <input type="text" class="form-control bg-dark text-light border-secondary" id="llm_model" required placeholder="qwen2.5:14b-instruct">
                                        <div class="form-text text-secondary">Model name or identifier (use Model Manager to download and import to Ollama).</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Context Window</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="llm_context_window" required min="1024" max="200000" step="1" placeholder="32768">
                                        <div class="form-text text-secondary">Maximum context size in tokens. MUST match model capabilities.</div>
                                    </div>
                                </div>
                                
                                <!-- Integrated Provider Specific Fields -->
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-light">Max Response Tokens</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="llm_max_response_tokens" required min="256" max="8192" placeholder="4096">
                                        <div class="form-text text-secondary">Maximum tokens for model responses.</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-light">Temperature</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="llm_temperature" required min="0" max="2" step="0.1" placeholder="0.7">
                                        <div class="form-text text-secondary">Creativity/randomness (0.0-2.0). Higher = more creative.</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-light">Timeout (seconds)</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="llm_timeout_seconds" required min="10" max="600" placeholder="120">
                                        <div class="form-text text-secondary">Request timeout for LLM API calls.</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="llm_unload_during_image_generation">
                                            <label class="form-check-label text-light" for="llm_unload_during_image_generation">
                                                Unload during image/video generation <span class="badge bg-info">VRAM Management</span>
                                            </label>
                                            <div class="form-text text-secondary">Free up VRAM by unloading LLM during media generation. Increases generation speed but adds reload time.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Configuration -->
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="bi bi-database me-2"></i>Memory & Embedding Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Embedding Model</label>
                                        <input type="text" class="form-control bg-dark text-light border-secondary" id="memory_embedding_model" required placeholder="all-MiniLM-L6-v2">
                                        <div class="form-text text-secondary">Sentence transformer model for memory embeddings.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Vector Store</label>
                                        <select class="form-select bg-dark text-light border-secondary" id="memory_vector_store" required>
                                            <option value="chroma">Chroma</option>
                                        </select>
                                        <div class="form-text text-secondary">Vector database for memory storage.</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label text-light">Default Budget (tokens)</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="memory_default_budget_tokens" required min="100" max="10000" placeholder="1000">
                                        <div class="form-text text-secondary">Default token budget for memory retrieval.</div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label text-light">Explicit Min Similarity</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="memory_explicit_minimum" required min="0" max="1" step="0.01" placeholder="0.70">
                                        <div class="form-text text-secondary">Minimum similarity for explicit memories (0.0-1.0).</div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label text-light">Implicit Min Similarity</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="memory_implicit_minimum" required min="0" max="1" step="0.01" placeholder="0.75">
                                        <div class="form-text text-secondary">Minimum similarity for implicit memories (0.0-1.0).</div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label text-light">Search API Min</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="memory_search_api_minimum" required min="0" max="1" step="0.01" placeholder="0.65">
                                        <div class="form-text text-secondary">Minimum similarity for search API (0.0-1.0).</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ComfyUI Configuration -->
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="bi bi-image me-2"></i>ComfyUI Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="comfyui_enabled">
                                            <label class="form-check-label text-light" for="comfyui_enabled">
                                                Enable ComfyUI Integration
                                            </label>
                                            <div class="form-text text-secondary">Enable image and video generation via ComfyUI.</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="comfyui_settings" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-light">ComfyUI URL</label>
                                            <input type="url" class="form-control bg-dark text-light border-secondary" id="comfyui_url" placeholder="http://localhost:8188">
                                            <div class="form-text text-secondary">ComfyUI server address.</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-light">Polling Interval (seconds)</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="comfyui_polling_interval_seconds" min="0.5" max="10" step="0.5" placeholder="2.0">
                                            <div class="form-text text-secondary">How often to check job status.</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label text-light">Image Timeout (seconds)</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="comfyui_timeout_seconds" min="30" max="1800" placeholder="300">
                                            <div class="form-text text-secondary">Maximum time for image generation.</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label text-light">Video Timeout (seconds)</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="comfyui_video_timeout_seconds" min="60" max="3600" placeholder="600">
                                            <div class="form-text text-secondary">Maximum time for video generation.</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label text-light">Max Concurrent Jobs</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="comfyui_max_concurrent_jobs" min="1" max="10" placeholder="2">
                                            <div class="form-text text-secondary">Maximum parallel generation jobs.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Document Analysis Configuration -->
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Document Analysis Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="document_analysis_enabled">
                                            <label class="form-check-label text-light" for="document_analysis_enabled">
                                                Enable Document Analysis
                                            </label>
                                            <div class="form-text text-secondary">Enable document ingestion and semantic search.</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="document_analysis_settings" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label text-light">Default Max Chunks</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="document_analysis_default_max_chunks" min="1" max="50" placeholder="3">
                                            <div class="form-text text-secondary">Fallback chunk limit.</div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label text-light">Max Chunks Cap</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="document_analysis_max_chunks_cap" min="1" max="100" placeholder="25">
                                            <div class="form-text text-secondary">Absolute safety limit.</div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label text-light">Chunk Token Estimate</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="document_analysis_chunk_token_estimate" min="128" max="2048" placeholder="512">
                                            <div class="form-text text-secondary">Average chunk size (tokens).</div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label text-light">Budget Ratio</label>
                                            <input type="number" class="form-control bg-dark text-light border-secondary" id="document_analysis_document_budget_ratio" min="0.05" max="0.5" step="0.05" placeholder="0.15">
                                            <div class="form-text text-secondary">% of context for documents (0.15 = 15%).</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- General Configuration -->
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>General Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-light">API Host</label>
                                        <input type="text" class="form-control bg-dark text-light border-secondary" id="api_host" required placeholder="localhost">
                                        <div class="form-text text-secondary">Server bind address (use 0.0.0.0 for network access).</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-light">API Port</label>
                                        <input type="number" class="form-control bg-dark text-light border-secondary" id="api_port" required min="1024" max="65535" placeholder="8080">
                                        <div class="form-text text-secondary">Server port number.</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check form-switch mt-4">
                                            <input class="form-check-input" type="checkbox" id="debug">
                                            <label class="form-check-label text-light" for="debug">
                                                Debug Mode
                                            </label>
                                            <div class="form-text text-secondary">Enable detailed logging.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- UI Configuration -->
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="bi bi-palette me-2"></i>User Interface</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-light">Color Scheme</label>
                                        <select class="form-select bg-dark text-light border-secondary" id="ui_color_scheme">
                                            <option value="stage-night">Stage Night (default)</option>
                                            <option value="spotlight-bright">Spotlight Bright</option>
                                            <option value="noir-absolute">Noir Absolute</option>
                                            <option value="cobalt-depths">Cobalt Depths</option>
                                            <option value="forest-canopy">Forest Canopy</option>
                                            <option value="ember-glow">Ember Glow</option>
                                            <option value="monochrome-studio">Monochrome Studio</option>
                                            <option value="sunset-boulevard">Sunset Boulevard</option>
                                            <option value="arctic-twilight">Arctic Twilight</option>
                                        </select>
                                        <div class="form-text text-secondary">System default theme. Can be overridden per-character.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="mt-4">
                                            <button type="button" class="btn btn-sm btn-outline-light" id="previewThemeBtn">
                                                <i class="bi bi-eye me-1"></i>Preview Selected Theme
                                            </button>
                                            <div class="form-text text-secondary mt-2">Preview changes without saving. Note: Requires server restart to become new default.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-warning" id="saveSystemSettingsBtn">
                        <i class="bi bi-save me-1"></i>Save & Restart Server
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Library Modal -->
    <div class="modal fade" id="documentLibraryModal" tabindex="-1" aria-labelledby="documentLibraryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentLibraryModalLabel">
                        <i class="bi bi-file-earmark-text text-primary"></i> Document Library
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Stats Bar -->
                    <div class="row mb-4" id="docStats">
                        <div class="col-md-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-body text-center">
                                    <h2 class="text-primary mb-0" id="statTotalDocs">0</h2>
                                    <small class="text-light">Documents</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-body text-center">
                                    <h2 class="text-info mb-0" id="statTotalChunks">0</h2>
                                    <small class="text-light">Total Chunks</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-body text-center">
                                    <h2 class="text-success mb-0" id="statStorageSize">0 MB</h2>
                                    <small class="text-light">Storage Used</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark border-secondary">
                                <div class="card-body text-center">
                                    <h2 class="text-warning mb-0" id="statAvgChunks">0</h2>
                                    <small class="text-light">Avg Chunks/Doc</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Zone -->
                    <div class="card bg-dark border-secondary mb-4" id="uploadZone">
                        <div class="card-body text-center py-4" style="border: 3px dashed #444; border-radius: 8px; cursor: pointer;">
                            <h4 class="text-light"><i class="bi bi-cloud-upload text-primary"></i> Drop Files Here</h4>
                            <p class="text-theme-secondary mb-3">Or click to browse</p>
                            <p class="small text-theme-tertiary mb-3">Supported: PDF, DOCX, TXT, CSV, XLSX, Markdown</p>
                            
                            <div class="row justify-content-center" onclick="event.stopPropagation();">
                                <div class="col-md-4">
                                    <label class="form-label small">Chunking Method</label>
                                    <select id="chunkMethod" class="form-select form-select-sm bg-dark text-white" onclick="event.stopPropagation();">
                                        <option value="semantic">Semantic (Recommended)</option>
                                        <option value="fixed_size">Fixed Size</option>
                                        <option value="paragraph">By Paragraph</option>
                                        <option value="sentence">By Sentence</option>
                                    </select>
                                </div>
                            </div>
                            
                            <input type="file" id="docFileInput" style="display: none;" multiple accept=".pdf,.docx,.txt,.csv,.xlsx,.md">
                        </div>
                    </div>

                    <!-- Document List -->
                    <div id="documentsContainer">
                        <div class="text-center py-5" id="docLoadingSpinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading documents...</span>
                            </div>
                        </div>
                        <div id="documentsTableContainer" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Type</th>
                                            <th>Size</th>
                                            <th>Chunks</th>
                                            <th>Scope</th>
                                            <th>Uploaded</th>
                                            <th>Reference</th>
                                            <th style="width: 80px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="documentsList">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="documentsEmpty" class="text-center py-5" style="display: none;">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #999;"></i>
                            <p class="text-theme-secondary mt-3">No documents uploaded yet</p>
                            <p class="small text-theme-tertiary">Upload documents to reference them in conversations using <code>#doc:filename</code></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Upload Details Modal -->
    <div class="modal fade" id="docUploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title (optional)</label>
                        <input type="text" class="form-control bg-dark text-white" id="docTitle" placeholder="Auto-detected from filename">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-control bg-dark text-white" id="docDescription" rows="3" placeholder="Brief description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Privacy Scope</label>
                        <select class="form-select bg-dark text-white" id="docScope">
                            <option value="conversation">🔒 Conversation Only (Highest Privacy)</option>
                            <option value="character">👤 Character-Wide (All Conversations)</option>
                            <option value="global">🌐 Global (System-Wide)</option>
                        </select>
                        <small class="form-text text-light d-block mt-1" id="docScopeHelp"></small>
                    </div>
                    <div id="docUploadProgress" style="display: none;">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-theme-secondary mt-2">Uploading and processing...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmDocUpload">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Conversation Confirmation Modal -->
    <div class="modal fade" id="deleteConversationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-trash"></i> Delete Conversation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This conversation has <strong id="deleteConvMessageCount">0</strong> messages.</p>
                    <div id="deleteConvMemoryInfo" class="alert alert-info" style="display: none;">
                        <i class="bi bi-info-circle"></i>
                        It also has <strong id="deleteConvMemoryCount">0</strong> extracted memories.
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="deleteConvKeepMemories" checked>
                        <label class="form-check-label" for="deleteConvKeepMemories">
                            <strong>Keep memories (recommended)</strong><br>
                            <small class="text-light">Character will remember facts from this conversation in future chats.</small>
                        </label>
                    </div>
                    
                    <p class="text-danger mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>This action cannot be undone.</strong>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteConversation">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Title Modal -->
    <div class="modal fade" id="editTitleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Conversation Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="newTitleInput" class="form-control" placeholder="Enter new title">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTitleBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Conversation Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-download me-2"></i>
                        Export Conversation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="markdown" selected>Markdown (.md) - Beautiful formatting</option>
                            <option value="text">Plain Text (.txt) - Simple format</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Include:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeMetadata" checked>
                            <label class="form-check-label" for="includeMetadata">
                                Metadata (character, dates, message count)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">
                                Conversation Summary (if analyzed)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeMemories">
                            <label class="form-check-label" for="includeMemories">
                                Extracted Memories
                            </label>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        The exported file will be saved to your downloads folder and also stored in <code>data/exports/</code>.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmExportBtn">
                        <i class="bi bi-download me-1"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Immersion Notice Modal -->
    <div class="modal fade" id="immersionNoticeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle-fill text-info me-2"></i>
                        Character Notice
                    </h5>
                </div>
                <div class="modal-body" id="immersionNoticeText">
                    <!-- Populated by JS -->
                </div>
                <div class="modal-footer">
                    <div class="form-check me-auto">
                        <input class="form-check-input" type="checkbox" id="dontShowAgainCheck">
                        <label class="form-check-label" for="dontShowAgainCheck">
                            Don't show this again for this character
                        </label>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Character Management Modal -->
    <div class="modal fade" id="characterManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-gear me-2"></i>
                        Character Configuration
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Character List -->
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Characters</h6>
                                <button id="newCharacterBtn" class="btn btn-primary btn-sm">
                                    <i class="bi bi-plus-circle"></i> New
                                </button>
                            </div>
                            <div id="characterListPanel" class="list-group" style="max-height: 600px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Character Editor -->
                        <div class="col-md-8">
                            <div id="characterEditorPlaceholder" class="text-center text-muted py-5">
                                <i class="bi bi-person-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">Select a character to edit or create a new one</p>
                            </div>
                            <form id="characterForm" style="display: none;">
                                <!-- Tab Navigation -->
                                <ul class="nav nav-tabs mb-3" id="characterConfigTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-panel" type="button" role="tab">Basic</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="immersion-tab" data-bs-toggle="tab" data-bs-target="#immersion-panel" type="button" role="tab">Immersion</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory-panel" type="button" role="tab">Memory</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features-panel" type="button" role="tab">Features</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="voice-tab" data-bs-toggle="tab" data-bs-target="#voice-panel" type="button" role="tab">Voice/TTS</button>
                                    </li>
                                </ul>
                                
                                <!-- Tab Content -->
                                <div class="tab-content" id="characterConfigContent" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                                    
                                    <!-- BASIC TAB -->
                                    <div class="tab-pane fade show active" id="basic-panel" role="tabpanel">
                                        <div class="mb-3">
                                            <label class="form-label">Character ID <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="charId" required 
                                                   pattern="[a-z0-9_\-]+" 
                                                   placeholder="e.g., my-assistant">
                                            <small class="text-theme-secondary">Lowercase letters, numbers, underscores, hyphens only. Cannot be changed after creation.</small>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="charName" required 
                                                       placeholder="e.g., My Assistant">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Role Type</label>
                                                <select class="form-select" id="charRoleType">
                                                    <option value="assistant">Assistant - General-purpose helper</option>
                                                    <option value="companion">Companion - Conversational partner</option>
                                                    <option value="analyst">Analyst - Document/data analysis</option>
                                                    <option value="other">Other - Custom/specialized</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Role Description <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="charRole" required 
                                                   placeholder="e.g., Helpful Research Assistant">
                                            <small class="text-theme-secondary">Brief description shown in character selector</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">System Prompt <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="charSystemPrompt" rows="10" required 
                                                      placeholder="Define the character's personality and behavior..."></textarea>
                                            <small class="text-theme-secondary">Core instructions that define how the character behaves</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charCustomSystemPrompt">
                                                <label class="form-check-label" for="charCustomSystemPrompt">
                                                    <strong>⚡ Custom System Prompt (Power User Mode)</strong>
                                                </label>
                                            </div>
                                            <small class="text-theme-secondary d-block mt-1">
                                                Advanced: Use system_prompt exactly as written, bypassing all automatic immersion guidance. 
                                                Only enable for specialized use cases where you need complete control.
                                            </small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Personality Traits</label>
                                            <input type="text" class="form-control" id="charTraits" 
                                                   placeholder="e.g., thoughtful, creative, analytical">
                                            <small class="text-theme-secondary">Comma-separated list of adjectives</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Profile Image</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="charProfileImage" 
                                                       placeholder="e.g., character_name_profile.png">
                                                <button type="button" class="btn btn-outline-secondary" id="uploadProfileImageBtn" title="Upload Profile Picture">
                                                    <i class="bi bi-upload"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" id="setImageFocusBtn" title="Set Image Focus Point">
                                                    <i class="bi bi-bullseye"></i>
                                                </button>
                                            </div>
                                            <input type="file" id="profileImageFileInput" accept=".png,.jpg,.jpeg,.webp" style="display: none;">
                                            <small class="text-theme-secondary">Filename in data/character_images/ or click upload button to add a new image</small>
                                            <input type="hidden" id="charImageFocusX" value="50">
                                            <input type="hidden" id="charImageFocusY" value="50">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Color Scheme</label>
                                            <select class="form-select" id="charColorScheme">
                                                <option value="">Use System Default</option>
                                                <option value="stage-night">Stage Night</option>
                                                <option value="spotlight-bright">Spotlight Bright</option>
                                                <option value="noir-absolute">Noir Absolute</option>
                                                <option value="cobalt-depths">Cobalt Depths</option>
                                                <option value="forest-canopy">Forest Canopy</option>
                                                <option value="ember-glow">Ember Glow</option>
                                                <option value="monochrome-studio">Monochrome Studio</option>
                                                <option value="sunset-boulevard">Sunset Boulevard</option>
                                                <option value="arctic-twilight">Arctic Twilight</option>
                                            </select>
                                            <small class="text-theme-secondary">Theme to use when this character is selected (leave as system default unless you want character-specific theming)</small>
                                        </div>
                                        
                                        <!-- Preferred LLM Collapsible -->
                                        <div class="mb-3">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#llmPrefsCollapse">
                                                <i class="bi bi-chevron-down"></i> Preferred LLM Settings (Optional)
                                            </button>
                                            <div class="collapse mt-2" id="llmPrefsCollapse">
                                                <div class="card card-body bg-dark">
                                                    <small class="text-theme-secondary mb-2">Override system defaults for this character. All use system LLM provider.</small>
                                                    <div class="row">
                                                        <div class="col-12 mb-3">
                                                            <label class="form-label">Model</label>
                                                            
                                                            <!-- Model Selection Toggle -->
                                                            <div class="btn-group btn-group-sm mb-2 w-100" role="group">
                                                                <input type="radio" class="btn-check" name="charLlmModelMode" id="charLlmModelModeSelect" value="select" checked>
                                                                <label class="btn btn-outline-secondary" for="charLlmModelModeSelect">
                                                                    <i class="bi bi-list-ul me-1"></i>Select from Downloaded
                                                                </label>
                                                                
                                                                <input type="radio" class="btn-check" name="charLlmModelMode" id="charLlmModelModeCustom" value="custom">
                                                                <label class="btn btn-outline-secondary" for="charLlmModelModeCustom">
                                                                    <i class="bi bi-pencil me-1"></i>Custom Model Name
                                                                </label>
                                                            </div>
                                                            
                                                            <!-- Select from Downloaded Models -->
                                                            <div id="charLlmModelSelectContainer">
                                                                <select class="form-select form-select-sm" id="charLlmModelSelect">
                                                                    <option value="">System Default</option>
                                                                </select>
                                                                <small class="text-theme-secondary">Choose from models downloaded via Model Manager</small>
                                                            </div>
                                                            
                                                            <!-- Custom Model Input -->
                                                            <div id="charLlmModelCustomContainer" style="display: none;">
                                                                <input type="text" class="form-control form-control-sm" id="charLlmModel" 
                                                                       placeholder="e.g., qwen2.5:14b">
                                                                <small class="text-warning">
                                                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                                                    Make sure this model is already pulled in Ollama
                                                                </small>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-4 mb-2">
                                                            <label class="form-label">Temperature</label>
                                                            <input type="number" class="form-control form-control-sm" id="charLlmTemperature" 
                                                                   min="0" max="2" step="0.1" placeholder="0.7">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label class="form-label">Max Tokens</label>
                                                            <input type="number" class="form-control form-control-sm" id="charLlmMaxTokens" 
                                                                   placeholder="2048">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label class="form-label">Context Window</label>
                                                            <input type="number" class="form-control form-control-sm" id="charLlmContextWindow" 
                                                                   placeholder="8192">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- IMMERSION TAB -->
                                    <div class="tab-pane fade" id="immersion-panel" role="tabpanel">
                                        <div id="immersionDisabledWarning" class="alert alert-warning" style="display: none;">
                                            <i class="bi bi-exclamation-triangle"></i> 
                                            Immersion settings are disabled when Custom System Prompt mode is enabled.
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Immersion Level</label>
                                            <select class="form-select" id="charImmersionLevel">
                                                <option value="minimal">Minimal - Traditional AI assistant</option>
                                                <option value="balanced">Balanced - Preferences & opinions</option>
                                                <option value="full">Full - Personality with experiences</option>
                                                <option value="unbounded">Unbounded - Complete roleplay</option>
                                            </select>
                                            <small class="text-theme-secondary">Controls how "in-character" the AI behaves</small>
                                        </div>
                                        
                                        <h6 class="mt-4 mb-3">Immersion Settings</h6>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charAllowPreferences" checked>
                                                <label class="form-check-label" for="charAllowPreferences">
                                                    Allow Preferences <small class="text-theme-secondary">- Can express personal preferences</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charAllowOpinions" checked>
                                                <label class="form-check-label" for="charAllowOpinions">
                                                    Allow Opinions <small class="text-theme-secondary">- Can have and express opinions</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charAllowExperiences">
                                                <label class="form-check-label" for="charAllowExperiences">
                                                    Allow Experiences <small class="text-theme-secondary">- Can reference personal experiences</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charAllowPhysicalMetaphor">
                                                <label class="form-check-label" for="charAllowPhysicalMetaphor">
                                                    Allow Physical Metaphor <small class="text-theme-secondary">- Can use physical metaphors ("I feel energized")</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charAllowPhysicalSensation">
                                                <label class="form-check-label" for="charAllowPhysicalSensation">
                                                    Allow Physical Sensation <small class="text-theme-secondary">- Can describe physical sensations</small>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3 mt-3">
                                            <label class="form-label">Disclaimer Behavior</label>
                                            <select class="form-select" id="charDisclaimerBehavior">
                                                <option value="never">Never - Never mention being AI</option>
                                                <option value="only_when_asked">Only When Asked - Clarify if questioned</option>
                                                <option value="always">Always - Regular AI disclaimers</option>
                                            </select>
                                        </div>
                                        
                                        <h6 class="mt-4 mb-3">Emotional Range</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Baseline Emotion</label>
                                            <select class="form-select" id="charEmotionalBaseline">
                                                <option value="positive">Positive</option>
                                                <option value="neutral">Neutral</option>
                                                <option value="contemplative">Contemplative</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Allowed Emotions</label>
                                            <input type="text" class="form-control" id="charEmotionalAllowed" 
                                                   placeholder="e.g., positive, curious, thoughtful, encouraging">
                                            <small class="text-theme-secondary">Comma-separated list</small>
                                        </div>
                                    </div>
                                    
                                    <!-- MEMORY TAB -->
                                    <div class="tab-pane fade" id="memory-panel" role="tabpanel">
                                        <h6 class="mb-3">Memory Configuration</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Memory Scope</label>
                                            <select class="form-select" id="charMemoryScope">
                                                <option value="character">Character - Separate per character</option>
                                                <option value="global">Global - Shared across all</option>
                                                <option value="thread">Thread - Per conversation</option>
                                            </select>
                                        </div>
                                        
                                        <h6 class="mt-4 mb-3">Core Memories</h6>
                                        <small class="text-theme-secondary d-block mb-2">Important background facts that define the character</small>
                                        <div id="coreMemoriesList" class="mb-3">
                                            <!-- Populated dynamically -->
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="addCoreMemoryBtn">
                                            <i class="bi bi-plus-circle"></i> Add Core Memory
                                        </button>
                                        
                                        <h6 class="mt-4 mb-3">Memory Profile</h6>
                                        <small class="text-theme-secondary d-block mb-2">Control what types of memories are extracted from conversations</small>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charExtractFacts" checked>
                                                <label class="form-check-label" for="charExtractFacts">
                                                    Extract Facts <small class="text-theme-secondary">- Basic factual information</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charExtractProjects" checked>
                                                <label class="form-check-label" for="charExtractProjects">
                                                    Extract Projects <small class="text-theme-secondary">- Goals, plans, ongoing projects</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charExtractExperiences">
                                                <label class="form-check-label" for="charExtractExperiences">
                                                    Extract Experiences <small class="text-theme-secondary">- Shared experiences (null = use immersion defaults)</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charExtractStories">
                                                <label class="form-check-label" for="charExtractStories">
                                                    Extract Stories <small class="text-theme-secondary">- Narratives and anecdotes (null = use immersion defaults)</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charExtractRelationship">
                                                <label class="form-check-label" for="charExtractRelationship">
                                                    Extract Relationship <small class="text-theme-secondary">- Relationship dynamics (null = use immersion defaults)</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charTrackEmotionalWeight" checked>
                                                <label class="form-check-label" for="charTrackEmotionalWeight">
                                                    Track Emotional Weight <small class="text-theme-secondary">- Track emotional significance</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charTrackParticipants" checked>
                                                <label class="form-check-label" for="charTrackParticipants">
                                                    Track Participants <small class="text-theme-secondary">- Track who was involved</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- FEATURES TAB -->
                                    <div class="tab-pane fade" id="features-panel" role="tabpanel">
                                        <h6 class="mb-3">Media Generation</h6>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charImageGenEnabled">
                                                <label class="form-check-label" for="charImageGenEnabled">
                                                    <strong>Image Generation Enabled</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charVideoGenEnabled">
                                                <label class="form-check-label" for="charVideoGenEnabled">
                                                    <strong>Video Generation Enabled</strong>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <h6 class="mt-4 mb-3">Document Analysis</h6>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charDocAnalysisEnabled">
                                                <label class="form-check-label" for="charDocAnalysisEnabled">
                                                    <strong>Document Analysis Enabled</strong>
                                                </label>
                                            </div>
                                            <small class="text-theme-secondary d-block mt-1">Enable document ingestion, semantic search, Q&A with citations</small>
                                        </div>
                                        <div class="collapse mt-2" id="docAnalysisAdvanced">
                                            <div class="card card-body bg-dark">
                                                <small class="text-theme-secondary mb-2">Advanced Options</small>
                                                <div class="mb-2">
                                                    <label class="form-label">Max Documents</label>
                                                    <input type="number" class="form-control form-control-sm" id="charDocMaxDocuments" 
                                                           placeholder="Unlimited">
                                                    <small class="text-theme-secondary">Maximum documents this character can access</small>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Allowed Document Types</label>
                                                    <input type="text" class="form-control form-control-sm" id="charDocAllowedTypes" 
                                                           placeholder="e.g., policy, guideline, reference">
                                                    <small class="text-theme-secondary">Comma-separated list (empty = all types allowed)</small>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Max Chunks</label>
                                                    <input type="number" class="form-control form-control-sm" id="charDocMaxChunks" 
                                                           placeholder="System default">
                                                    <small class="text-theme-secondary">Maximum chunks to retrieve per query</small>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Document Budget Ratio</label>
                                                    <input type="number" class="form-control form-control-sm" id="charDocBudgetRatio" 
                                                           min="0" max="1" step="0.01" placeholder="System default">
                                                    <small class="text-theme-secondary">Portion of context window for documents (0.0-1.0)</small>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#docAnalysisAdvanced">
                                            <i class="bi bi-chevron-down"></i> Advanced Options
                                        </button>
                                        
                                        <h6 class="mt-4 mb-3">Code Execution</h6>
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charCodeExecEnabled">
                                                <label class="form-check-label" for="charCodeExecEnabled">
                                                    <strong>Code Execution Enabled</strong>
                                                </label>
                                            </div>
                                            <small class="text-theme-secondary d-block mt-1">Enable Python code generation and execution for data analysis</small>
                                        </div>
                                        <div class="collapse mt-2" id="codeExecAdvanced">
                                            <div class="card card-body bg-dark">
                                                <small class="text-theme-secondary mb-2">Advanced Options</small>
                                                <div class="mb-2">
                                                    <label class="form-label">Max Execution Time (seconds)</label>
                                                    <input type="number" class="form-control form-control-sm" id="charCodeMaxTime" 
                                                           value="30" placeholder="30">
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Allowed Libraries</label>
                                                    <input type="text" class="form-control form-control-sm" id="charCodeAllowedLibs" 
                                                           placeholder="e.g., pandas, numpy, matplotlib">
                                                    <small class="text-theme-secondary">Comma-separated list (empty = default whitelist)</small>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#codeExecAdvanced">
                                            <i class="bi bi-chevron-down"></i> Advanced Options
                                        </button>
                                    </div>
                                    
                                    <!-- VOICE/TTS TAB -->
                                    <div class="tab-pane fade" id="voice-panel" role="tabpanel">
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charVoiceEnabled">
                                                <label class="form-check-label" for="charVoiceEnabled">
                                                    <strong>Voice/TTS Enabled</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="charVoiceAlwaysOn">
                                                <label class="form-check-label" for="charVoiceAlwaysOn">
                                                    Always On <small class="text-theme-secondary">- Auto-generate TTS for every message</small>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">TTS Provider</label>
                                            <select class="form-select" id="charTtsProvider">
                                                <option value="comfyui">ComfyUI</option>
                                                <option value="chatterbox">Chatterbox (Embedded TTS)</option>
                                            </select>
                                        </div>
                                        
                                        <!-- ComfyUI Settings -->
                                        <div id="ttsComfyuiSettings" class="mb-3">
                                            <h6 class="mb-2">ComfyUI Settings</h6>
                                            <small class="text-theme-secondary d-block mb-2">Workflows and voice samples are managed via the Workflow Management UI</small>
                                            <div class="mb-2">
                                                <label class="form-label">Fallback Workflow Name</label>
                                                <input type="text" class="form-control" id="charTtsComfyWorkflow" 
                                                       placeholder="Optional fallback if no database workflow set">
                                            </div>
                                        </div>
                                        
                                        <!-- Chatterbox Settings -->
                                        <div id="ttsChatterboxSettings" class="mb-3" style="display: none;">
                                            <h6 class="mb-2">Chatterbox Settings</h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label">Temperature</label>
                                                    <input type="number" class="form-control" id="charTtsChatterboxTemp" 
                                                           min="0" max="1" step="0.1" value="0.8" placeholder="0.8">
                                                    <small class="text-theme-secondary">0.0 (monotone) to 1.0 (expressive)</small>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label">Chunk Threshold</label>
                                                    <input type="number" class="form-control" id="charTtsChatterboxChunkThreshold" 
                                                           value="200" placeholder="200">
                                                    <small class="text-theme-secondary">Max characters per chunk (~13-15s audio)</small>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="charTtsChatterboxCloning" checked>
                                                    <label class="form-check-label" for="charTtsChatterboxCloning">
                                                        Use Voice Cloning
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                                
                                <!-- Form Actions -->
                                <div class="d-flex gap-2 mt-3 border-top pt-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Save Character
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="cloneCharacterBtn">
                                        <i class="bi bi-files"></i> Clone
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="exportCharacterCardBtn">
                                        <i class="bi bi-card-image"></i> Export Card
                                    </button>
                                    <button type="button" class="btn btn-outline-danger ms-auto" id="deleteCharacterBtn">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                                <div id="characterFormStatus" class="alert d-none mt-2" role="alert"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Memory Panel Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="memoryPanel" style="width: 600px;">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title">
                <i class="bi bi-database me-2"></i>
                Memory Manager
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Character Info -->
            <div class="alert alert-info" id="memoryCharacterInfo">
                <strong id="memoryCharacterName">No character selected</strong>
            </div>
            
            <!-- Search & Filter Controls -->
            <div class="mb-3">
                <div class="input-group mb-2">
                    <input type="text" id="memorySearchInput" class="form-control" placeholder="Semantic search...">
                    <button type="button" id="memorySearchBtn" class="btn btn-outline-secondary">
                        <i class="bi bi-search"></i>
                    </button>
                    <button type="button" id="memoryClearSearchBtn" class="btn btn-outline-secondary" style="display: none;">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                
                <!-- Filter by Type -->
                <div class="mb-2">
                    <div class="btn-group w-100 mb-1" role="group">
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterAll" value="all" checked>
                        <label class="btn btn-outline-primary btn-sm" for="filterAll">All</label>
                        
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterCore" value="core">
                        <label class="btn btn-outline-primary btn-sm" for="filterCore">Core</label>
                        
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterExplicit" value="explicit">
                        <label class="btn btn-outline-primary btn-sm" for="filterExplicit">Explicit</label>
                        
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterFact" value="fact">
                        <label class="btn btn-outline-primary btn-sm" for="filterFact">Facts</label>
                    </div>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterProject" value="project">
                        <label class="btn btn-outline-warning btn-sm" for="filterProject">Projects</label>
                        
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterExperience" value="experience">
                        <label class="btn btn-outline-primary btn-sm" for="filterExperience">Experiences</label>
                        
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterStory" value="story">
                        <label class="btn btn-outline-secondary btn-sm" for="filterStory">Stories</label>
                        
                        <input type="radio" class="btn-check" name="memoryTypeFilter" id="filterRelationship" value="relationship">
                        <label class="btn btn-outline-success btn-sm" for="filterRelationship">Relationship</label>
                    </div>
                </div>
            </div>
            
            <!-- Memory Actions -->
            <div class="d-flex gap-2 mb-3">
                <button type="button" id="addExplicitMemoryBtn" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle"></i> Add Explicit Memory
                </button>
                <button type="button" id="addCoreMemoryBtn" class="btn btn-primary btn-sm" style="display: none;">
                    <i class="bi bi-star"></i> Add Core Memory
                </button>
            </div>
            
            <!-- Add Memory Form (Hidden by default) -->
            <div id="addMemoryForm" class="card mb-3" style="display: none;">
                <div class="card-body">
                    <h6 class="card-title">
                        <span id="memoryFormTitle">Add Explicit Memory</span>
                        <button type="button" class="btn-close float-end" id="cancelMemoryFormBtn"></button>
                    </h6>
                    <form id="memoryForm">
                        <div class="mb-2">
                            <label class="form-label">Content <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="memoryContent" rows="3" required 
                                      placeholder="Enter memory content..."></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Tags (optional)</label>
                            <input type="text" class="form-control" id="memoryTags" 
                                   placeholder="e.g., preference, skill, context">
                            <small class="text-muted">Comma-separated</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select form-select-sm" id="memoryPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-save"></i> Save
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="cancelMemoryFormBtn2">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="memoryStatus" class="alert d-none mb-3" role="alert"></div>
            
            <!-- Memory List -->
            <div id="memoryList" class="mb-3">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">No memories found</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Phase 4.1: Pending Memories Panel -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="pending-memories-panel" style="width: 600px;">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title">
                <i class="bi bi-hourglass-split me-2"></i>
                Pending Memories
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Review extracted memories</strong><br>
                <small>These facts were automatically extracted from conversations. Approve to remember them, or reject to discard.</small>
            </div>
            
            <!-- Select All -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="select-all-pending">
                <label class="form-check-label" for="select-all-pending">
                    Select All
                </label>
            </div>
            
            <!-- Pending Memories List -->
            <div id="pending-memories-list">
                <!-- Populated by JS -->
            </div>
            
            <!-- Batch Actions (Sticky Footer) -->
            <div class="batch-actions">
                <button id="batch-approve-btn" class="btn btn-success" disabled>
                    <i class="bi bi-check-lg"></i> Approve Selected
                </button>
                <button id="batch-reject-btn" class="btn btn-danger" disabled>
                    <i class="bi bi-x-lg"></i> Reject Selected
                </button>
            </div>
        </div>
    </div>
    
    <!-- Reset Database Confirmation Modal -->
    <div class="modal fade" id="resetDatabaseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Reset Database - WARNING
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <strong>THIS ACTION CANNOT BE UNDONE!</strong>
                    </div>
                    <p>This will permanently delete:</p>
                    <ul>
                        <li>All conversations and messages</li>
                        <li>All memories (core and extracted)</li>
                        <li>All vector store data</li>
                    </ul>
                    <p>Character definitions will be preserved.</p>
                    <hr>
                    <p class="mb-2"><strong>Type "RESET" to confirm:</strong></p>
                    <input type="text" id="resetConfirmInput" class="form-control" placeholder="Type RESET here">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmResetBtn" disabled>
                        <i class="bi bi-trash-fill me-1"></i> Reset Database
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Phase 5: Image Generation Confirmation Modal -->
    <div class="modal fade" id="imageConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-image-fill me-2"></i>
                        Generate Image?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">I detected you'd like an image. Here's what I'll generate:</p>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Prompt:</label>
                        <textarea id="imagePromptPreview" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Negative Prompt:</label>
                        <textarea id="imageNegativePromptPreview" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <!-- Phase 9: Workflow Selector -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Workflow:</label>
                        <select id="imageWorkflowSelector" class="form-select">
                            <option value="default">Default</option>
                        </select>
                    </div>
                    
                    <div id="imageTriggerInfo" class="alert alert-info d-none" role="alert">
                        <i class="bi bi-magic me-2"></i>
                        <small>This will include my character's trigger word for a self-portrait.</small>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="disableImageConfirmation">
                        <label class="form-check-label" for="disableImageConfirmation">
                            Don't ask again in this conversation
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmGenerateImageBtn">
                        <i class="bi bi-image-fill me-1"></i> Generate Image
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Confirmation Modal -->
    <div class="modal fade" id="videoConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-camera-video-fill me-2"></i>
                        Generate Video?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">I detected you'd like a video. Here's what I'll generate:</p>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Prompt:</label>
                        <textarea id="videoPromptPreview" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-clock me-2"></i>
                        <small><strong>Note:</strong> Video generation may take 2-10 minutes depending on complexity and workflow settings.</small>
                    </div>
                    
                    <!-- Video Workflow Selector -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Workflow:</label>
                        <select id="videoWorkflowSelector" class="form-select">
                            <option value="default">Default</option>
                        </select>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="disableVideoConfirmation">
                        <label class="form-check-label" for="disableVideoConfirmation">
                            Don't ask again in this conversation
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="App.confirmVideoGeneration()">
                        <i class="bi bi-camera-video-fill me-1"></i> Generate Video
                    </button>
                </div>
            </div>
        </div>
    </div>
    
<!-- Workflow Management Modal -->
    <div class="modal fade" id="workflowManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-diagram-3-fill me-2"></i>
                        Manage Workflows: <span id="workflowCharacterName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Workflow Type Selector (Phase 6.5) -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Workflow Type</label>
                        <div class="btn-group w-100" role="group" id="workflowTypeSelector">
                            <input type="radio" class="btn-check" name="workflowType" id="workflowTypeImage" value="image" checked autocomplete="off">
                            <label class="btn btn-outline-primary" for="workflowTypeImage">
                                <i class="bi bi-image me-1"></i> Image
                            </label>
                            
                            <input type="radio" class="btn-check" name="workflowType" id="workflowTypeTTS" value="audio" autocomplete="off">
                            <label class="btn btn-outline-primary" for="workflowTypeTTS">
                                <i class="bi bi-volume-up me-1"></i> TTS
                            </label>
                            
                            <input type="radio" class="btn-check" name="workflowType" id="workflowTypeVideo" value="video" autocomplete="off">
                            <label class="btn btn-outline-primary" for="workflowTypeVideo">
                                <i class="bi bi-camera-video me-1"></i> Video
                            </label>
                        </div>
                    </div>
                    
                    <!-- Placeholder Documentation -->
                    <div class="alert alert-info py-2 px-3 small" id="workflowPlaceholders">
                        <strong>Image Placeholders:</strong>
                        <code>__CHORUS_PROMPT__</code>, <code>__CHORUS_NEGATIVE__</code>, <code>__CHORUS_SEED__</code>
                    </div>
                    
                    <!-- Upload Section -->
                    <div class="mb-4">
                        <h6 class="mb-2">
                            <i class="bi bi-cloud-upload me-2"></i>
                            Upload New Workflow
                        </h6>
                        <div class="mb-2">
                            <label for="newWorkflowName" class="form-label small">Workflow Name</label>
                            <input type="text" id="newWorkflowName" class="form-control" placeholder="e.g., portrait, scene, default">
                        </div>
                        <div class="mb-3">
                            <label for="workflowFileInput" class="form-label small">Workflow File (API format)</label>
                            <input type="file" id="workflowFileInput" class="form-control" accept=".json">
                        </div>
                        <button type="button" class="btn btn-primary w-100" id="uploadWorkflowBtn">
                            <i class="bi bi-upload me-1"></i> Upload Workflow
                        </button>
                        <small class="text-muted d-block mt-2">Export your ComfyUI workflow in API format, then upload here.</small>
                    </div>
                    
                    <!-- Workflows List -->
                    <div>
                        <h6 class="mb-2">
                            <i class="bi bi-list-ul me-2"></i>
                            Existing Workflows
                        </h6>
                        <div id="workflowsList" class="list-group">
                            <!-- Populated by JS -->
                            <div class="text-center text-muted py-3">
                                <small>No workflows found. Upload one to get started.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voice Management Modal (Phase 6) -->
    <div class="modal fade" id="voiceManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-mic-fill me-2"></i>
                        Voice Samples: <span id="voiceCharacterName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Upload Section -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Upload New Voice Sample</h6>
                        </div>
                        <div class="card-body">
                            <form id="voiceUploadForm">
                                <div class="mb-3">
                                    <label for="voiceFileInput" class="form-label">Audio File</label>
                                    <input type="file" class="form-control" id="voiceFileInput" accept="audio/*" required>
                                    <div class="form-text">Supported formats: WAV, MP3, FLAC, OGG. Recommended: Clear, 3-10 second sample</div>
                                </div>
                                <div class="mb-3">
                                    <label for="voiceTranscriptInput" class="form-label">Transcript (Required)</label>
                                    <textarea class="form-control" id="voiceTranscriptInput" rows="3" placeholder="Type the exact words spoken in the voice sample..." required></textarea>
                                    <div class="form-text">The exact words spoken in the audio file. This helps the TTS model clone the voice accurately.</div>
                                </div>
                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="voiceDefaultCheck">
                                    <label class="form-check-label" for="voiceDefaultCheck">
                                        Set as default voice
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary" id="uploadVoiceBtn">
                                    <i class="bi bi-upload me-1"></i> Upload Voice Sample
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Existing Voices List -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Existing Voice Samples</h6>
                        </div>
                        <div class="card-body">
                            <div id="voicesList">
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-mic-mute-fill fs-1"></i>
                                    <p class="mt-2">No voice samples uploaded yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Focus Point Modal -->
    <div class="modal fade" id="imageFocusModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-bullseye me-2"></i> Set Image Focus Point
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Click on the face or focal point of your character image. This determines which part of the image is centered in the circular avatar.
                    </div>
                    <div id="focusPointContainer" class="position-relative" style="cursor: crosshair; max-width: 100%; margin: 0 auto; display: inline-block;">
                        <img id="focusPointImage" src="" alt="Character Image" 
                             style="max-width: 100%; height: auto; display: block; border: 2px solid var(--accent-primary); border-radius: 8px;">
                        <div id="focusPointMarker" style="position: absolute; width: 20px; height: 20px; border: 3px solid #d4af37; border-radius: 50%; background: rgba(212, 175, 55, 0.3); transform: translate(-50%, -50%); pointer-events: none; display: none; z-index: 10;">
                            <div style="position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #d4af37; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                        </div>
                    </div>
                    <div class="mt-3 text-center small text-muted">
                        <span id="focusPointCoords">Click to set focus point</span>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveFocusPointBtn">Save Focus Point</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Profile Modal -->
    <div class="modal fade" id="characterProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle me-2"></i> Character Profile
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left Column: Avatar and Basic Info -->
                        <div class="col-md-4">
                            <div class="text-center mb-4">
                                <img id="modalProfileAvatar" src="/character_images/default.svg" 
                                     alt="Character Avatar" class="modal-profile-avatar mb-3">
                                <h4 id="modalProfileName" class="text-white">Character Name</h4>
                                <p id="modalProfileRole" class="modal-label">Role</p>
                            </div>
                            
                            <!-- Statistics -->
                            <div class="card bg-secondary mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="stat-row mb-2">
                                        <span class="modal-label">Conversations:</span>
                                        <strong id="modalStatConversations" class="float-end">0</strong>
                                    </div>
                                    <div class="stat-row mb-2">
                                        <span class="modal-label">Messages:</span>
                                        <strong id="modalStatMessages" class="float-end">0</strong>
                                    </div>
                                    <div class="stat-row mb-2">
                                        <span class="modal-label">Memories:</span>
                                        <strong id="modalStatMemories" class="float-end">0</strong>
                                    </div>
                                    <div class="stat-row">
                                        <span class="modal-label">Core Memories:</span>
                                        <strong id="modalStatCore" class="float-end">0</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Capabilities -->
                            <div class="card bg-secondary">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Capabilities</h6>
                                </div>
                                <div class="card-body">
                                    <div id="modalCapabilities">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Detailed Info -->
                        <div class="col-md-8">
                            <!-- Personality Traits -->
                            <div class="card bg-secondary mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-heart me-2"></i>Personality</h6>
                                </div>
                                <div class="card-body">
                                    <div id="modalPersonalityTraits" class="d-flex flex-wrap gap-2">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Prompt -->
                            <div class="card bg-secondary mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-file-text me-2"></i>System Prompt</h6>
                                </div>
                                <div class="card-body">
                                    <p id="modalSystemPrompt" class="small text-theme-tertiary" style="white-space: pre-wrap;">
                                        <!-- Populated by JS -->
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Visual Identity -->
                            <div class="card bg-secondary mb-3" id="modalVisualIdentityCard" style="display: none;">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-palette me-2"></i>Visual Identity</h6>
                                </div>
                                <div class="card-body">
                                    <p id="modalVisualIdentity" class="small text-theme-tertiary" style="white-space: pre-wrap;">
                                        <!-- Populated by JS -->
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Configuration -->
                            <div class="card bg-secondary">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Configuration</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <span class="modal-label small">Immersion Level:</span><br>
                                            <strong id="modalImmersionLevel">-</strong>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <span class="modal-label small">Preferred Model:</span><br>
                                            <strong id="modalPreferredModel" class="small">-</strong>
                                        </div>
                                        <div class="col-6">
                                            <span class="modal-label small">Temperature:</span><br>
                                            <strong id="modalTemperature">-</strong>
                                        </div>
                                        <div class="col-6">
                                            <span class="modal-label small">Memory Scope:</span><br>
                                            <strong id="modalMemoryScope">-</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Character Modal -->
    <div class="modal fade" id="importCharacterModal" tabindex="-1" aria-labelledby="importCharacterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importCharacterModalLabel">
                        <i class="bi bi-upload me-2"></i>Import Character
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="importCharacterForm">
                        <div class="mb-3">
                            <label for="characterFileInput" class="form-label">Select Character YAML File</label>
                            <input type="file" class="form-control" id="characterFileInput" accept=".yaml,.yml" required>
                            <small class="text-light form-text">Upload a character configuration file (.yaml or .yml)</small>
                        </div>
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            If a character with the same ID exists, it will be overwritten (unless it's an immutable default character).
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="importCharacterBtn">
                        <i class="bi bi-upload me-1"></i>Import
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Character Card Modal -->
    <div class="modal fade" id="importCharacterCardModal" tabindex="-1" aria-labelledby="importCharacterCardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importCharacterCardModalLabel">
                        <i class="bi bi-card-image me-2"></i>Import Character Card
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cardUploadSection">
                        <div class="card border-secondary mb-3" id="cardDropZone" style="transition: all 0.2s;">
                            <div class="card-body text-center" style="padding: 2rem;">
                                <div class="mb-3">
                                    <i class="bi bi-card-image" id="cardUploadIcon" style="font-size: 3rem; color: var(--bs-secondary); transition: all 0.2s;"></i>
                                </div>
                                <h6 class="card-title">Upload Character Card</h6>
                                <p class="card-text text-muted small">
                                    Drag & drop a PNG file here, or click to browse
                                </p>
                                <p class="card-text text-muted small mb-3">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Supports Chorus Engine and SillyTavern V2/V3 character cards
                                </p>
                                <input type="file" id="cardFileInput" accept=".png" style="display: none;">
                                <button type="button" class="btn btn-primary" id="selectCardFileBtn">
                                    <i class="bi bi-upload me-1"></i>Select PNG File
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="cardPreviewSection" style="display: none;">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            Review the character details below before importing.
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <img id="cardPreviewImage" src="" alt="Character" class="img-fluid rounded">
                            </div>
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <label class="form-label small text-secondary">Format</label>
                                    <div id="cardPreviewFormat" class="fw-bold"></div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small text-secondary">Character Name</label>
                                    <div id="cardPreviewName" class="fw-bold"></div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small text-secondary">Description</label>
                                    <div id="cardPreviewDescription" class="small" style="max-height: 100px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="customCharacterName" class="form-label">Custom Name (Optional)</label>
                            <input type="text" class="form-control" id="customCharacterName" placeholder="Leave empty to use default name">
                            <small class="text-secondary form-text">Override the character name if needed</small>
                        </div>
                        
                        <div class="accordion" id="cardDetailsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cardPersonalityCollapse">
                                        Personality & Traits
                                    </button>
                                </h2>
                                <div id="cardPersonalityCollapse" class="accordion-collapse collapse" data-bs-parent="#cardDetailsAccordion">
                                    <div class="accordion-body">
                                        <div id="cardPreviewPersonality" class="small"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cardVoiceCollapse">
                                        Voice Configuration
                                    </button>
                                </h2>
                                <div id="cardVoiceCollapse" class="accordion-collapse collapse" data-bs-parent="#cardDetailsAccordion">
                                    <div class="accordion-body">
                                        <div id="cardPreviewVoice" class="small"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="backToUploadBtn">
                                <i class="bi bi-arrow-left me-1"></i>Choose Different File
                            </button>
                        </div>
                    </div>
                    
                    <div id="cardImportProgress" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Importing...</span>
                            </div>
                            <p>Importing character card...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmImportCardBtn" style="display: none;">
                        <i class="bi bi-check-circle me-1"></i>Import Character
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Character Card Modal -->
    <div class="modal fade" id="exportCharacterCardModal" tabindex="-1" aria-labelledby="exportCharacterCardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportCharacterCardModalLabel">
                        <i class="bi bi-card-image me-2"></i>Export Character Card
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Export your character as a portable PNG card that can be imported into Chorus Engine or SillyTavern.
                    </div>
                    
                    <!-- Profile Image Preview -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <img id="exportCardPreviewImage" src="" alt="Profile" class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
                                </div>
                                <div class="col">
                                    <h6 class="mb-1" id="exportCardCharacterName"></h6>
                                    <small class="text-muted" id="exportCardImageStatus"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Warning if no profile image -->
                    <div class="alert alert-warning mb-3" id="exportNoImageWarning" style="display: none;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>No Profile Image Set</strong>
                                <p class="mb-0 small mt-1">Character cards require a profile image. Please upload one to continue.</p>
                            </div>
                            <button type="button" class="btn btn-sm btn-warning" id="exportModalUploadBtn">
                                <i class="bi bi-upload me-1"></i>Upload Image
                            </button>
                        </div>
                    </div>
                    <input type="file" id="exportModalImageInput" accept=".png,.jpg,.jpeg,.webp" style="display: none;">
                    
                    <div id="exportOptionsSection">
                        <div class="mb-3">
                            <label class="form-label">Export Options</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportIncludeVoice" checked>
                                <label class="form-check-label" for="exportIncludeVoice">
                                    Include Voice Configuration
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportIncludeWorkflows" checked>
                                <label class="form-check-label" for="exportIncludeWorkflows">
                                    Include Workflow Preferences
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="exportVoiceSampleUrl" class="form-label">Voice Sample URL (Optional)</label>
                            <input type="url" class="form-control" id="exportVoiceSampleUrl" 
                                   placeholder="https://example.com/voice-sample.wav">
                            <small class="text-muted form-text">
                                Optional URL to a voice sample file for voice cloning
                            </small>
                        </div>
                    </div>
                    
                    <div id="exportCardProgress" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Exporting...</span>
                            </div>
                            <p class="small">Generating character card...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmExportCardBtn">
                        <i class="bi bi-download me-1"></i>Export Card
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import System Config Modal -->
    <div class="modal fade" id="importSystemConfigModal" tabindex="-1" aria-labelledby="importSystemConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importSystemConfigModalLabel">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i>Import System Config
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="importSystemConfigForm">
                        <div class="mb-3">
                            <label for="systemConfigFileInput" class="form-label">Select System Config YAML File</label>
                            <input type="file" class="form-control" id="systemConfigFileInput" accept=".yaml,.yml" required>
                            <small class="text-light form-text">Upload a system configuration file (system.yaml)</small>
                        </div>
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>WARNING:</strong> This will overwrite your current system configuration. A server restart is recommended after import.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="importSystemConfigBtn">
                        <i class="bi bi-upload me-1"></i>Import
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Server Logs Modal -->
    <div class="modal fade" id="serverLogsModal" tabindex="-1" aria-labelledby="serverLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serverLogsModalLabel">
                        <i class="bi bi-terminal me-2"></i>Server Logs
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <small class="text-light" id="serverLogInfo"></small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-2" id="downloadServerLogsBtn">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshServerLogsBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <pre id="serverLogsContent" class="bg-dark text-theme-secondary p-3 rounded" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; font-family: 'Courier New', monospace;">Loading...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Conversation Debug Logs Modal -->
    <div class="modal fade" id="conversationLogsModal" tabindex="-1" aria-labelledby="conversationLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conversationLogsModalLabel">
                        <i class="bi bi-journal-code me-2"></i>Debug Log: <span id="debugLogConversationTitle">Loading...</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <small class="text-light" id="conversationLogInfo"></small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-2" id="downloadConversationLogBtn">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshConversationLogsBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <pre id="conversationLogsContent" class="bg-dark text-theme-secondary p-3 rounded" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; font-family: 'Courier New', monospace;">Loading...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Extraction Logs Modal -->
    <div class="modal fade" id="extractionLogsModal" tabindex="-1" aria-labelledby="extractionLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="extractionLogsModalLabel">
                        <i class="bi bi-journal-text me-2"></i>Extraction Log: <span id="extractionLogConversationTitle">Loading...</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <small class="text-light" id="extractionLogInfo"></small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-2" id="downloadExtractionLogsBtn">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshExtractionLogsBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <pre id="extractionLogsContent" class="bg-dark text-theme-secondary p-3 rounded" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; font-family: 'Courier New', monospace;">Loading...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Request Logs Modal -->
    <div class="modal fade" id="imageRequestLogsModal" tabindex="-1" aria-labelledby="imageRequestLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageRequestLogsModalLabel">
                        <i class="bi bi-image me-2"></i>Image Request Log: <span id="imageRequestLogConversationTitle">Loading...</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <small class="text-light" id="imageRequestLogInfo"></small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-2" id="downloadImageRequestLogsBtn">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshImageRequestLogsBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <pre id="imageRequestLogsContent" class="bg-dark text-theme-secondary p-3 rounded" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; font-family: 'Courier New', monospace;">Loading...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container for Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- Message populated by JS -->
            </div>
        </div>
    </div>

    <!-- Model Selection Modal (Phase 10) -->
    <div class="modal fade" id="modelSelectionModal" tabindex="-1" aria-labelledby="modelSelectionLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modelSelectionLabel">
                        <i class="bi bi-cpu-fill me-2"></i>Model Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- GPU Info -->
                    <div id="gpuInfo" class="mb-3"></div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="modelTabsList" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="curated-tab" data-bs-toggle="tab" data-bs-target="#curatedTab" 
                                    type="button" role="tab" aria-controls="curatedTab" aria-selected="true">
                                <i class="bi bi-star-fill me-1"></i>Pre-tested Models
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="downloaded-tab" data-bs-toggle="tab" data-bs-target="#downloadedTab" 
                                    type="button" role="tab" aria-controls="downloadedTab" aria-selected="false">
                                <i class="bi bi-download me-1"></i>Downloaded Models
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#customTab" 
                                    type="button" role="tab" aria-controls="customTab" aria-selected="false">
                                <i class="bi bi-github me-1"></i>Custom (HuggingFace)
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="modelTabsContent">
                        <!-- Curated Models Tab -->
                        <div class="tab-pane fade show active" id="curatedTab" role="tabpanel" aria-labelledby="curated-tab">
                            <!-- Filters -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" class="form-control bg-dark text-light border-secondary" 
                                           id="modelSearchInput" placeholder="Search models...">
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select bg-dark text-light border-secondary" id="modelCategoryFilter">
                                        <option value="all">All Categories</option>
                                        <option value="balanced">⚖️ Balanced</option>
                                        <option value="creative">🎨 Creative</option>
                                        <option value="technical">🔧 Technical</option>
                                        <option value="advanced">🚀 Advanced</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select bg-dark text-light border-secondary" id="modelVramFilter">
                                        <option value="all">All VRAM Tiers</option>
                                        <option value="6gb">6GB VRAM or less</option>
                                        <option value="8gb">8GB VRAM or less</option>
                                        <option value="12gb">12GB VRAM or less</option>
                                        <option value="16gb">16GB VRAM or less</option>
                                        <option value="24gb">24GB VRAM or less</option>
                                        <option value="32gb">32GB VRAM or less</option>
                                        <option value="48gb">48GB VRAM or less</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Models Container -->
                            <div id="curatedModelsContainer">
                                <div class="text-center text-muted py-5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3">Loading models...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Downloaded Models Tab -->
                        <div class="tab-pane fade" id="downloadedTab" role="tabpanel" aria-labelledby="downloaded-tab">
                            <div id="downloadedModelsContainer">
                                <div class="text-center text-light py-5">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3">Loading models...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Model Tab -->
                        <div class="tab-pane fade" id="customTab" role="tabpanel" aria-labelledby="custom-tab">
                            <div class="alert alert-info border-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Add models from HuggingFace</strong>
                                <p class="mb-0 mt-2">Enter a HuggingFace GGUF repository URL. Ollama will download and manage the model for you.</p>
                            </div>

                            <div class="card bg-dark border-secondary text-light">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-light">HuggingFace Repository URL</label>
                                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                                               id="hfRepoUrl" placeholder="e.g., https://huggingface.co/bartowski/Llama-3.2-3B-Instruct-GGUF"
                                               onchange="modelManager.loadHFQuantizations()">
                                        <div class="form-text text-muted">Paste the full HuggingFace URL or just username/reponame</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-light">Quantization</label>
                                        <select class="form-select bg-dark text-light border-secondary" 
                                                id="hfQuantSelect" disabled>
                                            <option value="">Enter repository URL first...</option>
                                        </select>
                                        <div class="form-text text-muted">Available quantizations will load automatically</div>
                                    </div>
                                    <div id="hfModelPreview" class="mb-3" style="display: none;">
                                        <div class="alert alert-secondary">
                                            <strong>Ollama model name:</strong>
                                            <code id="hfModelName" class="text-info"></code>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" id="hfPullBtn" onclick="modelManager.pullHFModel()" disabled>
                                        <i class="bi bi-download me-1"></i>Pull Model via Ollama
                                    </button>
                                    <div id="hfLoadingStatus" class="mt-2" style="display: none;">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="text-muted">Loading quantizations...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Download Progress Modal (Phase 10) -->
    <div class="modal fade" id="modelDownloadModal" tabindex="-1" aria-labelledby="modelDownloadLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modelDownloadLabel">
                        <i class="bi bi-download me-2"></i>Downloading Model
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong id="downloadModelName">Model Name</strong>
                    </div>
                    
                    <div class="mb-3">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 id="downloadProgress" 
                                 style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-secondary">Size:</small>
                        <span id="downloadSize" class="text-light">0 MB / 0 MB</span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-secondary">Status:</small>
                        <span id="downloadStatus" class="text-light">Initializing...</span>
                    </div>
                    
                    <div class="alert alert-info mb-0 mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>This may take several minutes depending on model size and your internet connection.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Custom JS -->
    <script src="js/themes.js?v=2"></script>
    <script src="js/user.js?v=1"></script>
    <script src="js/api.js?v=11"></script>
    <script src="js/ui.js?v=8"></script>
    <script src="js/character-management.js?v=7"></script>
    <script src="js/character-cards.js?v=12"></script>
    <script src="js/workflow-management.js?v=2"></script>
    <script src="js/memory-panel.js?v=2"></script>
    <script src="js/pending-memories-panel.js?v=1"></script>
    <script src="js/system_settings.js?v=1"></script>
    <script src="js/model-management.js?v=1"></script>
    <script src="js/app.js?v=9"></script>
    <script src="js/document-library.js?v=1"></script>
    <script src="js/document-autocomplete.js?v=1"></script>
    
    <!-- Username Management Handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const setUsernameMenuItem = document.getElementById('setUsernameMenuItem');
            const usernameModal = new bootstrap.Modal(document.getElementById('usernameModal'));
            const usernameInput = document.getElementById('usernameInput');
            const currentUserId = document.getElementById('currentUserId');
            const saveUsernameBtn = document.getElementById('saveUsernameBtn');
            
            // Open username modal
            if (setUsernameMenuItem) {
                setUsernameMenuItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Populate current values
                    usernameInput.value = userManager.getUsername();
                    currentUserId.textContent = userManager.getUserId();
                    usernameModal.show();
                });
            }
            
            // Save username
            if (saveUsernameBtn) {
                saveUsernameBtn.addEventListener('click', function() {
                    const newUsername = usernameInput.value.trim() || 'User';
                    userManager.setUsername(newUsername);
                    usernameModal.hide();
                    
                    // Show confirmation
                    const toast = document.createElement('div');
                    toast.className = 'toast-notification';
                    toast.textContent = `Username set to: ${newUsername}`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                });
            }
        });
    </script>
    
    <!-- Document Library Button Handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const docLibBtn = document.getElementById('documentLibraryBtn');
            if (docLibBtn) {
                docLibBtn.addEventListener('click', function() {
                    // Open modal instead of new window
                    const modal = new bootstrap.Modal(document.getElementById('documentLibraryModal'));
                    modal.show();
                    
                    // Load documents when modal opens
                    if (window.DocumentLibrary) {
                        window.DocumentLibrary.loadStats();
                        window.DocumentLibrary.loadDocuments();
                    }
                });
            }
            
            // Initialize document autocomplete on message input
            const messageInput = document.getElementById('messageInput');
            if (messageInput && window.DocumentAutocomplete) {
                window.DocumentAutocomplete.init(messageInput);
            }
        });
    </script>
</body>
</html>



